<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field</title>
  <meta name="description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  <meta name="github-repo" content="sticky-pi/sticky-pi.github.io" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field" />
  
  <meta name="twitter:description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  

<meta name="author" content="Quentin Geissmann" />


<meta name="date" content="2023-01-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="user-manual.html"/>
<link rel="next" href="ml.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-188039384-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-188039384-1');
</script>

<!--jQuery-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!--import Bootstrap style-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
<!--
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
-->

<!-- Popper JS -->
<script src="https://unpkg.com/@popperjs/core@2"></script>

<!--import Bootstrap JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>
    
<!--import Cytoscape.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
<!--Popper wrapper for Cytoscape.js
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-popper/2.0.0/cytoscape-popper.min.js"></script>
-->
<script src="libs/cytoscape.js-popper-2.0.0/cytoscape-popper.js"></script>

<!-- EasyAutocomplete -->
<link rel="stylesheet" href="libs/EasyAutocomplete-1.3.6/dist/easy-autocomplete.min.css">
<script src="libs/EasyAutocomplete-1.3.6/dist/jquery.easy-autocomplete.min.js"></script>

<script src="js/custom.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="assets/logo/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/logo/favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">

<!--import tooltip lib,
apparently need to "Place at the very bottom of the <body>, ensuring they are placed before your own scripts."-->
<script src="https://unpkg.com/tippy.js@6"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/my_style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><img width="264" height="88" src="assets/logo/sticky_logo-text-doc.png"</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>2</b> Platform Overview</a></li>
<li class="chapter" data-level="3" data-path="hardware.html"><a href="hardware.html"><i class="fa fa-check"></i><b>3</b> Hardware</a>
<ul>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#overview-1"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#custom-board"><i class="fa fa-check"></i>Custom Board</a></li>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#d-printed-parts"><i class="fa fa-check"></i>3D-printed parts</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#assembly-graph"><i class="fa fa-check"></i>Assembly graph</a></li>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#modules"><i class="fa fa-check"></i>Modules</a>
<ul>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#battery-module"><i class="fa fa-check"></i>Battery module</a></li>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#sticky-card-drawer"><i class="fa fa-check"></i>Sticky Card Drawer</a></li>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#testing-station"><i class="fa fa-check"></i>Testing Station</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mobile-app.html"><a href="mobile-app.html"><i class="fa fa-check"></i><b>4</b> Mobile App</a>
<ul>
<li class="chapter" data-level="" data-path="mobile-app.html"><a href="mobile-app.html#installation"><i class="fa fa-check"></i>Installation</a>
<ul>
<li class="chapter" data-level="" data-path="mobile-app.html"><a href="mobile-app.html#through-google-play"><i class="fa fa-check"></i>Through Google Play</a></li>
<li class="chapter" data-level="" data-path="mobile-app.html"><a href="mobile-app.html#manual-installation"><i class="fa fa-check"></i>Manual Installation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mobile-app.html"><a href="mobile-app.html#configuration"><i class="fa fa-check"></i>Configuration</a></li>
<li class="chapter" data-level="" data-path="mobile-app.html"><a href="mobile-app.html#use"><i class="fa fa-check"></i>Use</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="user-manual.html"><a href="user-manual.html"><i class="fa fa-check"></i><b>5</b> User Manual</a>
<ul>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#first-boot-tunning-and-testing"><i class="fa fa-check"></i>First boot tunning and testing</a>
<ul>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#overview-2"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#detail"><i class="fa fa-check"></i>Detail</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#maintenance-and-data-harvesting"><i class="fa fa-check"></i>Maintenance and Data Harvesting</a>
<ul>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#maintenance"><i class="fa fa-check"></i>Maintenance</a></li>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#data-harvesting-process"><i class="fa fa-check"></i>Data Harvesting Process</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="web-server.html"><a href="web-server.html"><i class="fa fa-check"></i><b>6</b> Web Server</a>
<ul>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#general-description"><i class="fa fa-check"></i>General description</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#deployment"><i class="fa fa-check"></i>Deployment</a>
<ul>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#github-repository"><i class="fa fa-check"></i>Github repository</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#hosting"><i class="fa fa-check"></i>Hosting</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#security"><i class="fa fa-check"></i>Security</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#configuration-and-important-files"><i class="fa fa-check"></i>Configuration and important files</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#env-file"><i class="fa fa-check"></i><code>.env</code> file</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#secret.env-file"><i class="fa fa-check"></i><code>.secret.env</code> file</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#alternative-local-s3-server"><i class="fa fa-check"></i>Alternative local S3 server</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#deploy-script"><i class="fa fa-check"></i>Deploy script</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#check-the-api"><i class="fa fa-check"></i>Check the API</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#create-users"><i class="fa fa-check"></i>Create users</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#backups"><i class="fa fa-check"></i>Backups</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#additional-information"><i class="fa fa-check"></i>Additional information</a>
<ul>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#database"><i class="fa fa-check"></i>Database</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#nginx"><i class="fa fa-check"></i>Nginx</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#api"><i class="fa fa-check"></i>API</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#universal-insect-detector"><i class="fa fa-check"></i>Universal Insect Detector</a></li>
<li class="chapter" data-level="" data-path="web-server.html"><a href="web-server.html#webapp"><i class="fa fa-check"></i>Webapp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ml.html"><a href="ml.html"><i class="fa fa-check"></i><b>7</b> Machine Learning</a>
<ul>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#general-description-1"><i class="fa fa-check"></i>General description</a></li>
<li class="chapter" data-level="" data-path="user-manual.html"><a href="user-manual.html#prerequisites"><i class="fa fa-check"></i>General Prerequisites</a>
<ul>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#installation-1"><i class="fa fa-check"></i>Installation</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#project-organisation"><i class="fa fa-check"></i>Project organisation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#uid"><i class="fa fa-check"></i>Universal Insect Detector</a>
<ul>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#inference"><i class="fa fa-check"></i>Inference</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#training"><i class="fa fa-check"></i>Training</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#validation"><i class="fa fa-check"></i>Validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#sim"><i class="fa fa-check"></i>Siamese Insect Matcher</a>
<ul>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#inference-1"><i class="fa fa-check"></i>Inference</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#training-2"><i class="fa fa-check"></i>Training</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#validation-1"><i class="fa fa-check"></i>Validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#itc"><i class="fa fa-check"></i>Insect Tuboid Classifier</a>
<ul>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#training-3"><i class="fa fa-check"></i>Training</a></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#inference-2"><i class="fa fa-check"></i>Inference</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ml.html"><a href="ml.html#conclusion"><i class="fa fa-check"></i>Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="outreach.html"><a href="outreach.html"><i class="fa fa-check"></i><b>8</b> Outreach</a>
<ul>
<li class="chapter" data-level="" data-path="outreach.html"><a href="outreach.html#ubc-campus-living-lab"><i class="fa fa-check"></i>UBC Campus Living Lab</a></li>
<li class="chapter" data-level="" data-path="outreach.html"><a href="outreach.html#june-august-2021"><i class="fa fa-check"></i>June-August 2021</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="community.html"><a href="community.html"><i class="fa fa-check"></i><b>9</b> Issues and community</a>
<ul>
<li class="chapter" data-level="" data-path="community.html"><a href="community.html#citation"><i class="fa fa-check"></i>Citation</a></li>
<li class="chapter" data-level="" data-path="community.html"><a href="community.html#having-troubles"><i class="fa fa-check"></i>Having troubles</a></li>
<li class="chapter" data-level="" data-path="community.html"><a href="community.html#contributing"><i class="fa fa-check"></i>Contributing</a></li>
<li class="chapter" data-level="" data-path="community.html"><a href="community.html#authors-and-contacts"><i class="fa fa-check"></i>Authors and Contacts</a></li>
</ul></li>
<li class="divider"></li>
<li>
<a href="https://www.biorxiv.org/content/10.1101/2021.08.11.455750" target="blank">Cite Sticky Pi</a>
<a href="https://bookdown.org/yihui/bookdown/" target="blank">Published with bookdown</a>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Sticky Pi, a high-frequency smart insect trap to study daily activity in the field</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="web-server" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Web Server<a href="web-server.html#web-server" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This page describes how to deploy and maintain the web server.
As much as we try to streamline this process, deploying our web server on the cloud does require some familiarity with <a href="https://en.wikipedia.org/wiki/Linux">Unix/Linux</a> systems, <a href="https://www.docker.com/">Docker</a>. We are open for collaboration and may be able to help you deploy your server, so do not hesitate to <a href="/community#contact">contact us</a>.
First, we describe the general function of the server.
Second, we explain how to deploy and test it.
Last, for completeness, we provide additional information on the individual components.</p>
<div id="general-description" class="section level2 unnumbered hasAnchor">
<h2>General description<a href="web-server.html#general-description" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here is a schematics of how these services interact:</p>
<div class="figure"><span style="display:block;" id="fig:web-server"></span>
<img src="assets/web-server.png" alt="Schematics of the web server services"  />
<p class="caption">
Figure 6.1: Schematics of the web server services
</p>
</div>
<p>As shown in Figure <a href="web-server.html#fig:web-server">6.1</a>, the web server is a suite of docker containers.
The entry point is an <a href="https://en.wikipedia.org/wiki/Nginx">Nginx</a> server, <code>spi_nginx</code>, routes requests to the appropriate service:</p>
<ul>
<li><code>spi_api</code> &lt;- <code>api.*</code> – our overall API server (<em>i.e.</em> a server that handles client requests to, for instance, upload/download images, create new users, retrieve image metadata, etc).</li>
<li><code>spi_webapp</code> &lt;- <code>webapp.*</code> – an <a href="https://shiny.rstudio.com/">Rshiny</a> web interface to visualize data in real time.</li>
<li><code>spi_s3</code> &lt;- <code>s3.*</code> – an optional local s3 server, using <a href="https://github.com/localstack/localstack">localstack</a>. This is an alternative to subscribe to a commercial s3 server.</li>
</ul>
<p>The other services are not routed (i.e must not be accessible by external users):</p>
<ul>
<li><code>spi_db</code> – a <a href="https://mariadb.org/">mariadb</a> database that stores image metadata, user data, processing results, …</li>
<li><code>spi_uid</code> – a service that automatically pre-process all images, running the Universal Insect Detector, to segment insects vs background.</li>
<li><code>certbot</code> – a service based on <a href="https://certbot.eff.org/">certbot</a> that issues and renews SSL certificates in the background (for HTTPS)</li>
</ul>
</div>
<div id="deployment" class="section level2 unnumbered hasAnchor">
<h2>Deployment<a href="web-server.html#deployment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="github-repository" class="section level3 unnumbered hasAnchor">
<h3>Github repository<a href="web-server.html#github-repository" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The all the source code needed for deployment can be found on the <a href="https://github.com/sticky-pi/sticky-pi-api">sticky-pi-api github repository</a>. It contains two important subdirectories: <code>src</code>, a python package used to create the API, and <code>server</code>, a set of docker services orchestrated with <a href="https://docs.docker.com/compose/">docker compose</a>.</p>
<p>For deployment, we only care about the <code>server</code> – if you are interested, the API is documented on <a href="https://sticky-pi-api.readthedocs.io/en/develop/">readthedoc</a>, but it should only concern you if you want to take part in development.</p>
<p>Typically, you would clone this repository on your host.</p>
</div>
<div id="hosting" class="section level3 unnumbered hasAnchor">
<h3>Hosting<a href="web-server.html#hosting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest way to deploy the Sticky Pi server stack is on a remote Linux virtual machine.
Perhaps your institution provides some cloud hosting, for instance <a href="https://www.computecanada.ca/research-portal/national-services/compute-canada-cloud">Compute Canada Cloud</a>, or you can opt for a commercial cloud provider. You can also decide to run the server on a custom machine within a restricted network.</p>
</div>
<div id="security" class="section level3 unnumbered hasAnchor">
<h3>Security<a href="web-server.html#security" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A remote web resources implies security considerations:</p>
<ul>
<li>Your host should use firewalls, the web-server only needs ports 80 (http) and 443 (https) open</li>
<li>Ensure you use long, high entropy, passwords</li>
<li>Update your host system</li>
<li>Use ssh keys rather than passwords</li>
</ul>
</div>
<div id="configuration-and-important-files" class="section level3 unnumbered hasAnchor">
<h3>Configuration and important files<a href="web-server.html#configuration-and-important-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Within the <code>server</code> directory, there are a few noticeable files we will describe:</p>
<ul>
<li><code>deploy.sh</code> – A script you can run to deploy the whole stack. More details later.</li>
<li><code>docker-compose.yml</code> – The base docker-compose configuration file.</li>
<li><code>docker-compose.prod.yml</code> – The specification of the above file, for production.</li>
<li><code>.env</code> – An overall configuration file defining. <strong>You will need to modify some variables in it</strong>.</li>
<li><code>.secret.env</code> – Contains credentials. For security reasons, this file does not exist yet <strong>you need to create it</strong>. Do not share this file, and ensure the permissions are restrictive.</li>
</ul>
</div>
<div id="env-file" class="section level3 unnumbered hasAnchor">
<h3><code>.env</code> file<a href="web-server.html#env-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You need to create a directory that will contain all the server data (except the s3-hosted files). Set <code>LOCAL_VOLUME_ROOT</code> in the <code>.env</code> file accordingly: <code>LOCAL_VOLUME_ROOT=/your/sticky-pi/root/dirctory</code>.</p>
<p>In order to encrypt data flow between client and server, we enforce https. That implies the registration of a domain name. Typically, you want to:</p>
<ol style="list-style-type: decimal">
<li>Ensure your cloud provider can provide a static/floating IP address for your instance, say <code>111.112.113.114</code>.</li>
<li>Find a DNS provider and register your domain name, say <code>sticky.net</code>.</li>
<li>Use your DNS provider to create two A records: <code>sticky.net</code> -&gt; <code>111.112.113.114</code> and <code>*.sticky.net</code> -&gt; <code>111.112.113.114</code></li>
<li>Define <code>ROOT_DOMAIN_NAME</code> in the <code>.env</code> file to your registered domain name. E.g. <code>ROOT_DOMAIN_NAME=sticky.net</code></li>
</ol>
</div>
<div id="secret.env-file" class="section level3 unnumbered hasAnchor">
<h3><code>.secret.env</code> file<a href="web-server.html#secret.env-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Create or add to <code>.secret.env</code> file the variables by modifying this template:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="web-server.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># En encryption key can be any long sting of ascii characters,</span></span>
<span id="cb1-2"><a href="web-server.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g.  something like `cfbewif7y8rfy4w3aNIKFW9Yfh89HFN9`</span></span>
<span id="cb1-3"><a href="web-server.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="va">SECRET_API_KEY</span><span class="op">=</span></span>
<span id="cb1-4"><a href="web-server.html#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="web-server.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Your S3 host. We will describe further the difference between</span></span>
<span id="cb1-6"><a href="web-server.html#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># external and local S3 provider </span></span>
<span id="cb1-7"><a href="web-server.html#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For local option we can set</span></span>
<span id="cb1-8"><a href="web-server.html#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># S3_HOST=s3.${ROOT_DOMAIN_NAME}</span></span>
<span id="cb1-9"><a href="web-server.html#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># for remote option this would be a hostname like `my-s3.provider.com`</span></span>
<span id="cb1-10"><a href="web-server.html#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="va">S3_HOST</span><span class="op">=</span></span>
<span id="cb1-11"><a href="web-server.html#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="web-server.html#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># For local s3 option, you want to define arbitrary keys:</span></span>
<span id="cb1-13"><a href="web-server.html#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. S3_ACCESS_KEY=fnwfnoAEVikenAV and </span></span>
<span id="cb1-14"><a href="web-server.html#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># S3_PRIVATE_KEY=cfweavb87eabv8uehabv98hwAW7</span></span>
<span id="cb1-15"><a href="web-server.html#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># For remote option, you will need to issue a key pair and paste it</span></span>
<span id="cb1-16"><a href="web-server.html#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="va">S3_ACCESS_KEY</span><span class="op">=</span></span>
<span id="cb1-17"><a href="web-server.html#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="va">S3_PRIVATE_KEY</span><span class="op">=</span></span>
<span id="cb1-18"><a href="web-server.html#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="web-server.html#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># An arbitrary password, only used internally</span></span>
<span id="cb1-20"><a href="web-server.html#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Should be more than 10-characters long</span></span>
<span id="cb1-21"><a href="web-server.html#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="va">MYSQL_PASSWORD</span><span class="op">=</span></span>
<span id="cb1-22"><a href="web-server.html#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="web-server.html#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Another arbitrary password, only used internally</span></span>
<span id="cb1-24"><a href="web-server.html#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Should be more than 10-characters long</span></span>
<span id="cb1-25"><a href="web-server.html#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="va">API_ADMIN_PASSWORD</span><span class="op">=</span></span>
<span id="cb1-26"><a href="web-server.html#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="web-server.html#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Your email address (or the main admin&#39;s)</span></span>
<span id="cb1-28"><a href="web-server.html#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="va">ADMIN_EMAIL</span><span class="op">=</span></span>
<span id="cb1-29"><a href="web-server.html#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="web-server.html#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># The name of the S3 bucket storing the images </span></span>
<span id="cb1-31"><a href="web-server.html#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># and other binary files. E.g. `sticky-pi-prod`</span></span>
<span id="cb1-32"><a href="web-server.html#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="va">S3_BUCKET_NAME</span><span class="op">=</span></span>
<span id="cb1-33"><a href="web-server.html#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="web-server.html#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># An arbitrary password for the special user/internal bot `uid`,</span></span>
<span id="cb1-35"><a href="web-server.html#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># which can preprocess images automatically (universal insect detector). </span></span>
<span id="cb1-36"><a href="web-server.html#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Should be more than 10-characters long</span></span>
<span id="cb1-37"><a href="web-server.html#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="va">UID_PASSWORD</span><span class="op">=</span></span></code></pre></div>
</div>
<div id="alternative-local-s3-server" class="section level3 unnumbered hasAnchor">
<h3>Alternative local S3 server<a href="web-server.html#alternative-local-s3-server" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our recommended option is to use an external provider for S3.
However, you can also run your own S3 as a docker container.
To do that you just need to set <code>S3_HOST=s3.${ROOT_DOMAIN_NAME}</code> in the <code>.secret.env</code> file.
Your data will be stored, by default on <code>${LOCAL_VOLUME_ROOT}/s3</code>.
Beware that overall data can be large – typically [1, 2] GB per device per week.</p>
</div>
<div id="deploy-script" class="section level3 unnumbered hasAnchor">
<h3>Deploy script<a href="web-server.html#deploy-script" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once we have set up the environment variables, we are ready to deploy. For convenience, we provide a script: <code>server/deploy.sh</code> that should be used this way for a production server:</p>
<pre><code># sh deploy.sh prod-init
# sh deploy.sh prod</code></pre>
<p><code>prod-init</code> initializes SSL certificates. You should need to do that only once.
If you want to subsequently restart/redeploy the server, just run <code>sh deploy.sh prod</code>.</p>
<p>The first time, it may take a wile to build all the docker images.</p>
<p>Once all the images have been built, ensure containers are running using <code>docker ps</code>. you can also debug and check the logs by using <code>docker logs &lt;service_name&gt;</code>.</p>
</div>
<div id="check-the-api" class="section level3 unnumbered hasAnchor">
<h3>Check the API<a href="web-server.html#check-the-api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest way to test the API end to end is to use <a href="https://en.wikipedia.org/wiki/CURL">cURL</a> – you could also use our python client.
For instance, we can ask the API to issue a temporary logging token for the admin user.
Replace <code>&lt;API_ADMIN_PASSWORD&gt;</code> and <code>&lt;ROOT_DOMAIN_NAME&gt;</code> by their value (same as in <code>.secret.env</code>).</p>
<pre><code>curl --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST   https://api.&lt;ROOT_DOMAIN_NAME&gt;/get_token</code></pre>
<p>This should return a json dictionary with the fields <code>"expiration"</code> and <code>"token"</code>. If this does not work, stop here, and debug.</p>
</div>
<div id="create-users" class="section level3 unnumbered hasAnchor">
<h3>Create users<a href="web-server.html#create-users" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also use cURL to create users.
For instance, to create a read only user named <code>spi</code>, with password <code>R3ad_0nly</code>, and no email address, we can run:</p>
<pre><code>curl  --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST -H &quot;Content-Type: application/json&quot; -d &#39;[{&quot;username&quot;: &quot;spi&quot;, &quot;password&quot;: &quot;R3ad_0nly&quot;, &quot;is_admin&quot;: 0, &quot;email&quot;: &quot;&quot;, &quot;can_write&quot;:0}]&#39; https://api.&lt;ROOT_DOMAIN_NAME&gt;/put_users</code></pre>
<p><code>"can_write":1</code> would create a user that can write, and <code>"is_admin": 1</code>, an admin user (<em>e.g.</em> that can create other users).
Note that you will not be able to retrieve a user’s password as passwords are internally encrypted. If a password is lost, the only way to log in is to reset it.</p>
<p>You can list users with:</p>
<pre><code>curl --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST   https://api.sticky-pi.com/get_users</code></pre>
<p>You can test users by requesting a token, using curl as <a href="web-server.html#check-the-api">above</a>, replacing <code>--user admin:&lt;API_ADMIN_PASSWORD&gt;</code>, by <code>--user &lt;USERNAME&gt;:&lt;USER_PASSWORD&gt;</code>.</p>
</div>
<div id="backups" class="section level3 unnumbered hasAnchor">
<h3>Backups<a href="web-server.html#backups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The raw image data is on the s3 server. Manual backups/archives can be done by downlaoding all data to a separate resource/hard drive/… with tools such as <a href="https://s3tools.org/s3cmd">s3cmd</a>, using your credentials.
In order to backup mariadb, you can use the deploy script:</p>
<pre><code>#sh deploy.sh mysql-backup</code></pre>
<p>This will create a file like <code>spi_db.dump.YYYY-MM-DD.sql.gz</code> in the current working directory – that you then manually copy/archive. In case of catastrofic failure, the database could be restored with it.</p>
</div>
</div>
<div id="additional-information" class="section level2 unnumbered hasAnchor">
<h2>Additional information<a href="web-server.html#additional-information" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="database" class="section level3 unnumbered hasAnchor">
<h3>Database<a href="web-server.html#database" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The database (<code>spi_db</code>) is the <a href="https://hub.docker.com/_/mariadb">stock MariaDB</a>.
The database data is mounted on a persistent directory on the host: <code>${LOCAL_VOLUME_ROOT}/mysql</code> in the host maps <code>/var/lib/mysql</code> in the container.</p>
</div>
<div id="nginx" class="section level3 unnumbered hasAnchor">
<h3>Nginx<a href="web-server.html#nginx" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Nginx (<code>spi_nginx</code>) is the <a href="https://hub.docker.com/_/nginx">stock Nginx</a>.
We use a custom configuration file to define routing (<code>nginx/nging.conf-template</code>).
Note that this is a template file where we inject environment variable at built time.
You should not need to modify the configuration file for standard deployment</p>
</div>
<div id="api" class="section level3 unnumbered hasAnchor">
<h3>API<a href="web-server.html#api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The API (<code>spi_api</code>) is a <a href="https://uwsgi-docs.readthedocs.io/en/latest/">uwsgi</a> + <a href="https://flask.palletsprojects.com/en/1.1.x/">flask</a> server. The main file is <code>api/app.py</code>.
This server depends extensively on our python package, <a href="https://sticky-pi-api.readthedocs.io/en/latest/">sticky_pi_api</a>.
Note that the API and client are packaged together, which allows us to use mock local API vs remote API.</p>
</div>
<div id="universal-insect-detector" class="section level3 unnumbered hasAnchor">
<h3>Universal Insect Detector<a href="web-server.html#universal-insect-detector" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The UID (<code>spi_uid</code>) is a simple python script (<code>ml/uid.py</code>) that uses the API client and the our <a href="https://github.com/sticky-pi/sticky-pi-ml">sticky_pi_ml</a> package.
It fetches the images that are not annotated (or obsolete) from client, analyse them, and upload the results (to the database, through the API).
This process runs automatically. Note that you need to have either trained the UID or download a reference model for this service to work. We explain how to set-up ML resources in a <a href="/ml">dedicated section</a>.</p>
</div>
<div id="webapp" class="section level3 unnumbered hasAnchor">
<h3>Webapp<a href="web-server.html#webapp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Webapp (<code>spi_webapp</code>) is an Rshiny interactive website.
It is mainly designed to visualise image and processing data.
Typically hundreds of images are acquired every week, this interface allows you to select a date range to display a plot of environmental conditions and overlay images as well as UID results. This is very helpful to ensure the quality of your data in real time. The webapp will be available at <code>webapp.&lt;ROOT_DOMAIN_NAME&gt;</code>, as defined in <a href="web-server.html#hosting">hosting</a>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="user-manual.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ml.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/sticky-pi/sticky-pi.github.io/edit/source/05-web-server.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["sticky-pi.pdf", "sticky-pi.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
