<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field</title>
  <meta name="description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  <meta name="generator" content="bookdown 0.25.3 and GitBook 2.6.7" />

  <meta property="og:title" content="Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  <meta name="github-repo" content="sticky-pi/sticky-pi.github.io" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Web Server | Sticky Pi, a high-frequency smart insect trap to study daily activity in the field" />
  
  <meta name="twitter:description" content="This is the documentation for the Sticky Pi project, a system to study insect activity in the field." />
  

<meta name="author" content="Quentin Geissmann" />


<meta name="date" content="2022-03-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="hardware.html"/>
<link rel="next" href="ml.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-188039384-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-188039384-1');
</script>

<link rel="apple-touch-icon" sizes="180x180" href="assets/logo/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/logo/favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/my_style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><img width="264" height="88" src="assets/logo/sticky_logo-text-doc.png"</a></li>

<li class="divider"></li>
<li><a href="index.html#introduction">Introduction<a href="index.html#introduction" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="overview.html#overview">Platform Overview<a href="overview.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#hardware">Hardware<a href="hardware.html#hardware" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="hardware.html#device">Device<a href="hardware.html#device" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="hardware.html#overview-1">Overview<a href="hardware.html#overview-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#assembly">Assembly<a href="hardware.html#assembly" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#qc-and-troubleshooting">QC and troubleshooting<a href="hardware.html#qc-and-troubleshooting" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="hardware.html#data-harvester">Data harvester<a href="hardware.html#data-harvester" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="hardware.html#rapsberry-pi">Rapsberry Pi<a href="hardware.html#rapsberry-pi" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#router">Router<a href="hardware.html#router" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#assembly-1">Assembly<a href="hardware.html#assembly-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="hardware.html#qc-and-troubleshooting-1">QC and troubleshooting<a href="hardware.html#qc-and-troubleshooting-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="hardware.html#using-sticky-pis">Using Sticky Pis<a href="hardware.html#using-sticky-pis" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="web-server.html#web-server">Web Server<a href="web-server.html#web-server" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="web-server.html#general-description">General description<a href="web-server.html#general-description" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#deployment">Deployment<a href="web-server.html#deployment" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="web-server.html#github-repository">Github repository<a href="web-server.html#github-repository" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#hosting">Hosting<a href="web-server.html#hosting" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#security">Security<a href="web-server.html#security" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#configuration-and-important-files">Configuration and important files<a href="web-server.html#configuration-and-important-files" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#env-file"><code>.env</code> file<a href="web-server.html#env-file" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#secret.env-file"><code>.secret.env</code> file<a href="web-server.html#secret.env-file" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#alternative-local-s3-server">Alternative local S3 server<a href="web-server.html#alternative-local-s3-server" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#deploy-script">Deploy script<a href="web-server.html#deploy-script" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#check-the-api">Check the API<a href="web-server.html#check-the-api" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#create-users">Create users<a href="web-server.html#create-users" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#backups">Backups<a href="web-server.html#backups" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="web-server.html#additional-information">Additional information<a href="web-server.html#additional-information" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="web-server.html#database">Database<a href="web-server.html#database" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#nginx">Nginx<a href="web-server.html#nginx" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#api">API<a href="web-server.html#api" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#universal-insect-detector">Universal Insect Detector<a href="web-server.html#universal-insect-detector" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="web-server.html#webapp">Webapp<a href="web-server.html#webapp" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
</ul></li>
<li><a href="ml.html#ml">Machine Learning<a href="ml.html#ml" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="ml.html#general-description-1">General description<a href="ml.html#general-description-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#prerequisites">General Prerequisites<a href="ml.html#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="ml.html#installation">Installation<a href="ml.html#installation" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#project-organisation">Project organisation<a href="ml.html#project-organisation" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="ml.html#uid">Universal Insect Detector<a href="ml.html#uid" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="ml.html#inference">Inference<a href="ml.html#inference" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#training">Training<a href="ml.html#training" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#validation">Validation<a href="ml.html#validation" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="ml.html#sim">Siamese Insect Matcher<a href="ml.html#sim" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="ml.html#inference-1">Inference<a href="ml.html#inference-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#training-2">Training<a href="ml.html#training-2" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#validation-1">Validation<a href="ml.html#validation-1" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="ml.html#itc">Insect Tuboid Classifier<a href="ml.html#itc" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="ml.html#training-3">Training<a href="ml.html#training-3" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#validation-2">Validation<a href="ml.html#validation-2" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="ml.html#inference-2">Inference<a href="ml.html#inference-2" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
</ul></li>
<li><a href="outreach.html#outreach">Outreach<a href="outreach.html#outreach" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="outreach.html#ubc-campus-living-lab">UBC Campus Living Lab<a href="outreach.html#ubc-campus-living-lab" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="outreach.html#june-august-2021">June-August 2021<a href="outreach.html#june-august-2021" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li><a href="community.html#community">Issues and community<a href="community.html#community" class="anchor-section" aria-label="Anchor link to header"></a></a><ul>
<li><a href="community.html#citation">Citation<a href="community.html#citation" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="community.html#having-troubles">Having troubles<a href="community.html#having-troubles" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="community.html#contributing">Contributing<a href="community.html#contributing" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
<li><a href="community.html#contact">Contact<a href="community.html#contact" class="anchor-section" aria-label="Anchor link to header"></a></a></li>
</ul></li>
<li class="divider"></li>
<li>
<a href="https://www.biorxiv.org/content/10.1101/2021.08.11.455750" target="blank">Cite Sticky Pi</a>
<a href="https://bookdown.org/yihui/bookdown/" target="blank">Published with bookdown</a>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Sticky Pi, a high-frequency smart insect trap to study daily activity in the field</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="web-server" class="section level1 unnumbered hasAnchor">
<h1>Web Server<a href="web-server.html#web-server" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This page describes how to deploy and maintain the web server.
As much as we try to streamline this process, deploying our web server on the cloud does require some familiarity with <a href="https://en.wikipedia.org/wiki/Linux">Unix/Linux</a> systems, <a href="https://www.docker.com/">Docker</a>. We are open for collaboration and may be able to help you deploy your server, so do not hesitate to <a href="/community#contact">contact us</a>.
First, we describe the general function of the server.
Second, we explain how to deploy and test it.
Last, for completeness, we provide additional information on the individual components.</p>
<div id="general-description" class="section level2 unnumbered hasAnchor">
<h2>General description<a href="web-server.html#general-description" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here is a schematics of how these services interact:</p>
<div class="figure"><span style="display:block;" id="fig:web-server"></span>
<img src="assets/web-server.png" alt="Schematics of the web server services"  />
<p class="caption">
Figure 11: Schematics of the web server services
</p>
</div>
<p>As shown in Figure <a href="web-server.html#fig:web-server">11</a>, the web server is a suite of docker containers.
The entry point is an <a href="https://en.wikipedia.org/wiki/Nginx">Nginx</a> server, <code>spi_nginx</code>, routes requests to the appropriate service:</p>
<ul>
<li><code>spi_api</code> &lt;- <code>api.*</code> – our overall API server (<em>i.e.</em> a server that handles client requests to, for instance, upload/download images, create new users, retrieve image metadata, etc).</li>
<li><code>spi_webapp</code> &lt;- <code>webapp.*</code> – an <a href="https://shiny.rstudio.com/">Rshiny</a> web interface to visualize data in real time.</li>
<li><code>spi_s3</code> &lt;- <code>s3.*</code> – an optional local s3 server, using <a href="https://github.com/localstack/localstack">localstack</a>. This is an alternative to subscribe to a commercial s3 server.</li>
</ul>
<p>The other services are not routed (i.e must not be accessible by external users):</p>
<ul>
<li><code>spi_db</code> – a <a href="https://mariadb.org/">mariadb</a> database that stores image metadata, user data, processing results, …</li>
<li><code>spi_uid</code> – a service that automatically pre-process all images, running the Universal Insect Detector, to segment insects vs background.</li>
<li><code>certbot</code> – a service based on <a href="https://certbot.eff.org/">certbot</a> that issues and renews SSL certificates in the background (for HTTPS)</li>
</ul>
</div>
<div id="deployment" class="section level2 unnumbered hasAnchor">
<h2>Deployment<a href="web-server.html#deployment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="github-repository" class="section level3 unnumbered hasAnchor">
<h3>Github repository<a href="web-server.html#github-repository" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The all the source code needed for deployment can be found on the <a href="https://github.com/sticky-pi/sticky-pi-api">sticky-pi-api github repository</a>. It contains two important subdirectories: <code>src</code>, a python package used to create the API, and <code>server</code>, a set of docker services orchestrated with <a href="https://docs.docker.com/compose/">docker compose</a>.</p>
<p>For deployment, we only care about the <code>server</code> – if you are interested, the API is documented on <a href="https://sticky-pi-api.readthedocs.io/en/develop/">readthedoc</a>, but it should only concern you if you want to take part in development.</p>
<p>Typically, you would clone this repository on your host.</p>
</div>
<div id="hosting" class="section level3 unnumbered hasAnchor">
<h3>Hosting<a href="web-server.html#hosting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest way to deploy the Sticky Pi server stack is on a remote Linux virtual machine.
Perhaps your institution provides some cloud hosting, for instance <a href="https://www.computecanada.ca/research-portal/national-services/compute-canada-cloud">Compute Canada Cloud</a>, or you can opt for a commercial cloud provider. You can also decide to run the server on a custom machine within a restricted network.</p>
</div>
<div id="security" class="section level3 unnumbered hasAnchor">
<h3>Security<a href="web-server.html#security" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A remote web resources implies security considerations:</p>
<ul>
<li>Your host should use firewalls, the web-server only needs ports 80 (http) and 443 (https) open</li>
<li>Ensure you use long, high entropy, passwords</li>
<li>Update your host system</li>
<li>Use ssh keys rather than passwords</li>
</ul>
</div>
<div id="configuration-and-important-files" class="section level3 unnumbered hasAnchor">
<h3>Configuration and important files<a href="web-server.html#configuration-and-important-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Within the <code>server</code> directory, there are a few noticeable files we will describe:</p>
<ul>
<li><code>deploy.sh</code> – A script you can run to deploy the whole stack. More details later.</li>
<li><code>docker-compose.yml</code> – The base docker-compose configuration file.</li>
<li><code>docker-compose.prod.yml</code> – The specification of the above file, for production.</li>
<li><code>.env</code> – An overall configuration file defining. <strong>You will need to modify some variables in it</strong>.</li>
<li><code>.secret.env</code> – Contains credentials. For security reasons, this file does not exist yet <strong>you need to create it</strong>. Do not share this file, and ensure the permissions are restrictive.</li>
</ul>
</div>
<div id="env-file" class="section level3 unnumbered hasAnchor">
<h3><code>.env</code> file<a href="web-server.html#env-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You need to create a directory that will contain all the server data (except the s3-hosted files). Set <code>LOCAL_VOLUME_ROOT</code> in the <code>.env</code> file accordingly: <code>LOCAL_VOLUME_ROOT=/your/sticky-pi/root/dirctory</code>.</p>
<p>In order to encrypt data flow between client and server, we enforce https. That implies the registration of a domain name. Typically, you want to:</p>
<ol style="list-style-type: decimal">
<li>Ensure your cloud provider can provide a static/floating IP address for your instance, say <code>111.112.113.114</code>.</li>
<li>Find a DNS provider and register your domain name, say <code>sticky.net</code>.</li>
<li>Use your DNS provider to create two A records: <code>sticky.net</code> -&gt; <code>111.112.113.114</code> and <code>*.sticky.net</code> -&gt; <code>111.112.113.114</code></li>
<li>Define <code>ROOT_DOMAIN_NAME</code> in the <code>.env</code> file to your registered domain name. E.g. <code>ROOT_DOMAIN_NAME=sticky.net</code></li>
</ol>
</div>
<div id="secret.env-file" class="section level3 unnumbered hasAnchor">
<h3><code>.secret.env</code> file<a href="web-server.html#secret.env-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Create or add to <code>.secret.env</code> file the variables by modifying this template:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># En encryption key can be any long sting of ascii characters,</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># e.g.  something like `cfbewif7y8rfy4w3aNIKFW9Yfh89HFN9`</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="va">SECRET_API_KEY=</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co"># Your S3 host. We will describe further the difference between</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># external and local S3 provider </span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co"># For local option we can set</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co"># S3_HOST=s3.${ROOT_DOMAIN_NAME}</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># for remote option this would be a hostname like `my-s3.provider.com`</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="va">S3_HOST=</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># For local s3 option, you want to define arbitrary keys:</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co"># e.g. S3_ACCESS_KEY=fnwfnoAEVikenAV and </span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co"># S3_PRIVATE_KEY=cfweavb87eabv8uehabv98hwAW7</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co"># For remote option, you will need to issue a key pair and paste it</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="va">S3_ACCESS_KEY=</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="va">S3_PRIVATE_KEY=</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co"># An arbitrary password, only used internally</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co"># Should be more than 10-characters long</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="va">MYSQL_PASSWORD=</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co"># Another arbitrary password, only used internally</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co"># Should be more than 10-characters long</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="va">API_ADMIN_PASSWORD=</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co"># Your email address (or the main admin&#39;s)</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="va">ADMIN_EMAIL=</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="co"># The name of the S3 bucket storing the images </span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="co"># and other binary files. E.g. `sticky-pi-prod`</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="va">S3_BUCKET_NAME=</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="co"># An arbitrary password for the special user/internal bot `uid`,</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="co"># which can preprocess images automatically (universal insect detector). </span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36"><span class="co"># Should be more than 10-characters long</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37"><span class="va">UID_PASSWORD=</span></a></code></pre></div>
</div>
<div id="alternative-local-s3-server" class="section level3 unnumbered hasAnchor">
<h3>Alternative local S3 server<a href="web-server.html#alternative-local-s3-server" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our recommended option is to use an external provider for S3.
However, you can also run your own S3 as a docker container.
To do that you just need to set <code>S3_HOST=s3.${ROOT_DOMAIN_NAME}</code> in the <code>.secret.env</code> file.
Your data will be stored, by default on <code>${LOCAL_VOLUME_ROOT}/s3</code>.
Beware that overall data can be large – typically [1, 2] GB per device per week.</p>
</div>
<div id="deploy-script" class="section level3 unnumbered hasAnchor">
<h3>Deploy script<a href="web-server.html#deploy-script" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Once we have set up the environment variables, we are ready to deploy. For convenience, we provide a script: <code>server/deploy.sh</code> that should be used this way for a production server:</p>
<pre><code># sh deploy.sh prod-init
# sh deploy.sh prod</code></pre>
<p><code>prod-init</code> initializes SSL certificates. You should need to do that only once.
If you want to subsequently restart/redeploy the server, just run <code>sh deploy.sh prod</code>.</p>
<p>The first time, it may take a wile to build all the docker images.</p>
<p>Once all the images have been built, ensure containers are running using <code>docker ps</code>. you can also debug and check the logs by using <code>docker logs &lt;service_name&gt;</code>.</p>
</div>
<div id="check-the-api" class="section level3 unnumbered hasAnchor">
<h3>Check the API<a href="web-server.html#check-the-api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest way to test the API end to end is to use <a href="https://en.wikipedia.org/wiki/CURL">cURL</a> – you could also use our python client.
For instance, we can ask the API to issue a temporary logging token for the admin user.
Replace <code>&lt;API_ADMIN_PASSWORD&gt;</code> and <code>&lt;ROOT_DOMAIN_NAME&gt;</code> by their value (same as in <code>.secret.env</code>).</p>
<pre><code>curl --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST   https://api.&lt;ROOT_DOMAIN_NAME&gt;/get_token</code></pre>
<p>This should return a json dictionary with the fields <code>&quot;expiration&quot;</code> and <code>&quot;token&quot;</code>. If this does not work, stop here, and debug.</p>
</div>
<div id="create-users" class="section level3 unnumbered hasAnchor">
<h3>Create users<a href="web-server.html#create-users" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can also use cURL to create users.
For instance, to create a read only user named <code>spi</code>, with password <code>R3ad_0nly</code>, and no email address, we can run:</p>
<pre><code>curl  --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST -H &quot;Content-Type: application/json&quot; -d &#39;[{&quot;username&quot;: &quot;spi&quot;, &quot;password&quot;: &quot;R3ad_0nly&quot;, &quot;is_admin&quot;: 0, &quot;email&quot;: &quot;&quot;, &quot;can_write&quot;:0}]&#39; https://api.&lt;ROOT_DOMAIN_NAME&gt;/put_users</code></pre>
<p><code>&quot;can_write&quot;:1</code> would create a user that can write, and <code>&quot;is_admin&quot;: 1</code>, an admin user (<em>e.g.</em> that can create other users).
Note that you will not be able to retrieve a user’s password as passwords are internally encrypted. If a password is lost, the only way to log in is to reset it.</p>
<p>You can list users with:</p>
<pre><code>curl --user admin:&lt;API_ADMIN_PASSWORD&gt; -X POST   https://api.sticky-pi.com/get_users</code></pre>
<p>You can test users by requesting a token, using curl as <a href="web-server.html#check-the-api">above</a>, replacing <code>--user admin:&lt;API_ADMIN_PASSWORD&gt;</code>, by <code>--user &lt;USERNAME&gt;:&lt;USER_PASSWORD&gt;</code>.</p>
</div>
<div id="backups" class="section level3 unnumbered hasAnchor">
<h3>Backups<a href="web-server.html#backups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The raw image data is on the s3 server. Manual backups/archives can be done by downlaoding all data to a separate resource/hard drive/… with tools such as <a href="https://s3tools.org/s3cmd">s3cmd</a>, using your credentials.
In order to backup mariadb, you can use the deploy script:</p>
<pre><code>#sh deploy.sh mysql-backup</code></pre>
<p>This will create a file like <code>spi_db.dump.YYYY-MM-DD.sql.gz</code> in the current working directory – that you then manually copy/archive. In case of catastrofic failure, the database could be restored with it.</p>
</div>
</div>
<div id="additional-information" class="section level2 unnumbered hasAnchor">
<h2>Additional information<a href="web-server.html#additional-information" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="database" class="section level3 unnumbered hasAnchor">
<h3>Database<a href="web-server.html#database" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The database (<code>spi_db</code>) is the <a href="https://hub.docker.com/_/mariadb">stock MariaDB</a>.
The database data is mounted on a persistent directory on the host: <code>${LOCAL_VOLUME_ROOT}/mysql</code> in the host maps <code>/var/lib/mysql</code> in the container.</p>
</div>
<div id="nginx" class="section level3 unnumbered hasAnchor">
<h3>Nginx<a href="web-server.html#nginx" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Nginx (<code>spi_nginx</code>) is the <a href="https://hub.docker.com/_/nginx">stock Nginx</a>.
We use a custom configuration file to define routing (<code>nginx/nging.conf-template</code>).
Note that this is a template file where we inject environment variable at built time.
You should not need to modify the configuration file for standard deployment</p>
</div>
<div id="api" class="section level3 unnumbered hasAnchor">
<h3>API<a href="web-server.html#api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The API (<code>spi_api</code>) is a <a href="https://uwsgi-docs.readthedocs.io/en/latest/">uwsgi</a> + <a href="https://flask.palletsprojects.com/en/1.1.x/">flask</a> server. The main file is <code>api/app.py</code>.
This server depends extensively on our python package, <a href="https://sticky-pi-api.readthedocs.io/en/latest/">sticky_pi_api</a>.
Note that the API and client are packaged together, which allows us to use mock local API vs remote API.</p>
</div>
<div id="universal-insect-detector" class="section level3 unnumbered hasAnchor">
<h3>Universal Insect Detector<a href="web-server.html#universal-insect-detector" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The UID (<code>spi_uid</code>) is a simple python script (<code>ml/uid.py</code>) that uses the API client and the our <a href="https://github.com/sticky-pi/sticky-pi-ml">sticky_pi_ml</a> package.
It fetches the images that are not annotated (or obsolete) from client, analyse them, and upload the results (to the database, through the API).
This process runs automatically. Note that you need to have either trained the UID or download a reference model for this service to work. We explain how to set-up ML resources in a <a href="/ml">dedicated section</a>.</p>
</div>
<div id="webapp" class="section level3 unnumbered hasAnchor">
<h3>Webapp<a href="web-server.html#webapp" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Webapp (<code>spi_webapp</code>) is an Rshiny interactive website.
It is mainly designed to visualise image and processing data.
Typically hundreds of images are acquired every week, this interface allows you to select a date range to display a plot of environmental conditions and overlay images as well as UID results. This is very helpful to ensure the quality of your data in real time. The webapp will be available at <code>webapp.&lt;ROOT_DOMAIN_NAME&gt;</code>, as defined in <a href="web-server.html#hosting">hosting</a>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="hardware.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ml.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/sticky-pi/sticky-pi.github.io/edit/source/05-web-server.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["sticky-pi.pdf", "sticky-pi.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
